<div class="admin-container">
  <!-- Admin Header -->
  <div class="admin-header theme-major-color text-light">
    <div class="container-fluid">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h2 class="mb-0">Order Management</h2>
          <small>Manage customer orders and delivery status</small>
        </div>
        <div class="col-md-6">
          <div class="admin-nav float-end">
            <a routerLink="/admin/dashboard" class="btn btn-outline-light me-2">Dashboard</a>
            <a routerLink="/admin/products" class="btn btn-outline-light me-2" *ngIf="adminAuth.canManageProducts()">Products</a>
            <a routerLink="/admin/orders" class="btn btn-outline-light me-2" *ngIf="adminAuth.canManageOrders()">Orders</a>
            <a routerLink="/admin/customers" class="btn btn-outline-light me-2" *ngIf="adminAuth.canManageCustomers()">Customers</a>

            <button (click)="onAdminLogout()" class="btn btn-outline-danger me-2">
              <svg width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0v2z"/>
                <path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
              </svg>
              Logout
            </button>
            <a routerLink="/" class="btn btn-light">Back to Store</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container-fluid py-4">
    
    <!-- Filters Section -->
    <div class="card mb-4">
      <div class="card-header theme-major-color text-light">
        <h5 class="mb-0">Filter Orders</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-2 mb-3">
            <label class="form-label">Order Status</label>
            <select class="form-select" [(ngModel)]="filters.status" (ngModelChange)="applyFilters()">
              <option value="">All Statuses</option>
              <option *ngFor="let status of orderStatuses" [value]="status">{{ status | titlecase }}</option>
            </select>
          </div>
          
          <div class="col-md-2 mb-3">
            <label class="form-label">Payment Status</label>
            <select class="form-select" [(ngModel)]="filters.paymentStatus" (ngModelChange)="applyFilters()">
              <option value="">All Payment</option>
              <option *ngFor="let status of paymentStatuses" [value]="status">{{ status | titlecase }}</option>
            </select>
          </div>
          
          <div class="col-md-2 mb-3">
            <label class="form-label">From Date</label>
            <input type="date" class="form-control" [(ngModel)]="filters.dateFrom" (ngModelChange)="applyFilters()">
          </div>
          
          <div class="col-md-2 mb-3">
            <label class="form-label">To Date</label>
            <input type="date" class="form-control" [(ngModel)]="filters.dateTo" (ngModelChange)="applyFilters()">
          </div>
          
          <div class="col-md-3 mb-3">
            <label class="form-label">Customer/Order Number</label>
            <input 
              type="text" 
              class="form-control" 
              placeholder="Search customer name, email, or order number"
              [(ngModel)]="filters.customer" 
              (ngModelChange)="applyFilters()">
          </div>
          
          <div class="col-md-1 mb-3 d-flex align-items-end">
            <button class="btn btn-outline-secondary" (click)="clearFilters()">Clear</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Orders Summary -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="text-primary">{{ getTotalOrdersCount() }}</h3>
            <p class="mb-0">Total Orders</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="text-success">{{ getOrderCountByStatus('delivered') }}</h3>
            <p class="mb-0">Delivered</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="text-warning">{{ getOrderCountByStatus('processing') }}</h3>
            <p class="mb-0">Processing</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="text-info">{{ getOrderCountByStatus('shipped') }}</h3>
            <p class="mb-0">Shipped</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading orders...</span>
      </div>
      <p class="mt-2">Loading orders...</p>
    </div>

    <!-- Orders Table -->
    <div *ngIf="!isLoading" class="card">
      <div class="card-header theme-major-color text-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          Orders ({{ filteredOrders.length }} of {{ allOrders.length }})
        </h5>
        <div class="d-flex align-items-center">
          <label class="form-label text-light me-2 mb-0">Items per page:</label>
          <select 
            class="form-select form-select-sm items-per-page-select" 
            style="width: auto;" 
            [(ngModel)]="itemsPerPage"
            (ngModelChange)="changeItemsPerPage($event)">
            <option [value]="5">5</option>
            <option [value]="10">10</option>
            <option [value]="25">25</option>
            <option [value]="50">50</option>
          </select>
        </div>
      </div>
      
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th (click)="sortBy('orderNumber')" style="cursor: pointer;">
                  Order Number {{ getSortIcon('orderNumber') }}
                </th>
                <th (click)="sortBy('customerName')" style="cursor: pointer;">
                  Customer {{ getSortIcon('customerName') }}
                </th>
                <th (click)="sortBy('orderDate')" style="cursor: pointer;">
                  Order Date {{ getSortIcon('orderDate') }}
                </th>
                <th (click)="sortBy('total')" style="cursor: pointer;">
                  Total {{ getSortIcon('total') }}
                </th>
                <th (click)="sortBy('orderStatus')" style="cursor: pointer;">
                  Order Status {{ getSortIcon('orderStatus') }}
                </th>
                <th (click)="sortBy('paymentStatus')" style="cursor: pointer;">
                  Payment {{ getSortIcon('paymentStatus') }}
                </th>
                
               <th style="text-align: center;">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let order of paginatedOrders; trackBy: trackByOrderId" [class.table-secondary]="order.isArchived" [class.text-muted]="order.isArchived">
                <!-- Order Number -->
                <td>
                  <strong>{{ order.orderNumber }}</strong>
                  <br>
                  <small class="text-muted">ID: {{ order.id }}</small>
                  <small *ngIf="order.orderStatus === 'cancelled'" class="text-muted d-block">
                    Cancelled on {{ formatDate(order.cancelledAt || order.orderDate) }}
                  </small>
                </td>
                
                <!-- Customer -->
                <td>
                  <div>{{ order.customerInfo.fullName }}</div>
                  <small class="text-muted">{{ order.customerInfo.email }}</small>
                  <br>
                  <small class="text-muted">{{ order.customerInfo.phone }}</small>
                </td>
                
                <!-- Order Date -->
                <td>
                  <div>{{ formatDate(order.orderDate) }}</div>
                  <small class="text-muted">
                    Delivery: {{ order.estimatedDelivery | date }}
                  </small>
                </td>
                
                <!-- Total -->
                <td>
                  <strong>{{ formatCurrency(order.total) }}</strong>
                </td>
                
                <!-- Order Status -->
                <td>
                  <span [ngClass]="getStatusBadgeClass(order.orderStatus)">
                    {{ order.orderStatus | titlecase }}
                  </span>
                  <div *ngIf="order.orderStatus === 'cancelled' && order.cancellationReason" class="small text-muted mt-1">
                    Reason: {{ order.cancellationReason }}
                  </div>
                </td>
                
                <!-- Payment Status -->
                <td>
                  <span [ngClass]="getPaymentStatusBadgeClass(order.paymentStatus)">
                    {{ order.paymentStatus | titlecase }}
                  </span>
                </td>
                
                <!-- Items Count -->
               
                
                <!-- Actions -->
                <td>
                  <div class="btn-group" role="group">
                    <button 
                      class="btn btn-outline-primary btn-sm"
                      (click)="viewOrderDetails(order)"
                      title="View Details">
                      <i class="fas fa-eye"></i> View
                    </button>
                    <button 
                      class="btn btn-outline-success btn-sm"
                      (click)="openProcessingModal(order)"
                      title="Update Order"
                      *ngIf="adminAuth.canManageOrders() && !order.isArchived">
                      <i class="fas fa-edit"></i> Update
                    </button>
                    <button 
                      class="btn btn-outline-danger btn-sm"
                      (click)="openRemoveModal(order)"
                      title="Remove Order"
                      *ngIf="adminAuth.canManageOrders() && !order.isArchived">
                      <i class="fas fa-trash"></i> Remove
                    </button>
                    <span *ngIf="order.isArchived" class="badge bg-info">
                      <i class="fas fa-archive"></i> Archived Order
                    </span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Pagination -->
      <div class="card-footer">
        <nav>
          <ul class="pagination justify-content-center mb-0">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <button class="page-link" (click)="changePage(currentPage - 1)">Previous</button>
            </li>
            
            <li *ngFor="let page of [].constructor(totalPages); let i = index" 
                class="page-item" 
                [class.active]="currentPage === i + 1">
              <button class="page-link" (click)="changePage(i + 1)">{{ i + 1 }}</button>
            </li>
            
            <li class="page-item" [class.disabled]="currentPage === totalPages">
              <button class="page-link" (click)="changePage(currentPage + 1)">Next</button>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- Order Details Modal -->
  <div *ngIf="showOrderDetails && selectedOrder" 
       style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; overflow-y: auto;">
    <div style="margin: 20px auto; max-width: 900px; background: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
      
      <!-- Modal Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #1e40af; color: white; border-radius: 8px 8px 0 0;">
        <h4 style="margin: 0; color: white;">Order Details - {{ selectedOrder.orderNumber }}</h4>
        <button type="button" (click)="closeOrderDetails()" style="background: none; border: none; color: white; font-size: 30px; cursor: pointer;">&times;</button>
      </div>

      <!-- Modal Content -->
      <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
        <div class="row">
          <!-- Order Information -->
          <div class="col-md-6">
            <h5 style="color: #1e40af;">Order Information</h5>
            <table class="table table-sm">
              <tr>
                <td><strong>Order Number:</strong></td>
                <td>{{ selectedOrder.orderNumber }}</td>
              </tr>
              <tr>
                <td><strong>Order Date:</strong></td>
                <td>{{ formatDate(selectedOrder.orderDate) }}</td>
              </tr>
              <tr>
                <td><strong>Order Status:</strong></td>
                <td>
                  <span [ngClass]="getStatusBadgeClass(selectedOrder.orderStatus)">
                    {{ selectedOrder.orderStatus | titlecase }}
                  </span>
                </td>
              </tr>
              <tr>
                <td><strong>Payment Status:</strong></td>
                <td>
                  <span [ngClass]="getPaymentStatusBadgeClass(selectedOrder.paymentStatus)">
                    {{ selectedOrder.paymentStatus | titlecase }}
                  </span>
                </td>
              </tr>
              <tr>
                <td><strong>Total Amount:</strong></td>
                <td><strong>{{ formatCurrency(selectedOrder.total) }}</strong></td>
              </tr>
              <tr>
                <td><strong>Estimated Delivery:</strong></td>
                <td>{{ selectedOrder.estimatedDelivery | date }}</td>
              </tr>
            </table>
          </div>

          <!-- Customer Information -->
          <div class="col-md-6">
            <h5 style="color: #1e40af;">Customer Information</h5>
            <table class="table table-sm">
              <tr>
                <td><strong>Name:</strong></td>
                <td>{{ selectedOrder.customerInfo.fullName }}</td>
              </tr>
              <tr>
                <td><strong>Email:</strong></td>
                <td>{{ selectedOrder.customerInfo.email }}</td>
              </tr>
              <tr>
                <td><strong>Phone:</strong></td>
                <td>{{ selectedOrder.customerInfo.phone }}</td>
              </tr>
            </table>

            <h6 style="color: #1e40af; margin-top: 20px;">Shipping Address</h6>
            <address style="font-size: 14px;">
              {{ selectedOrder.shippingAddress.fullName }}<br>
              {{ selectedOrder.shippingAddress.addressLine1 }}<br>
              <span *ngIf="selectedOrder.shippingAddress.addressLine2">{{ selectedOrder.shippingAddress.addressLine2 }}<br></span>
              {{ selectedOrder.shippingAddress.city }}, {{ selectedOrder.shippingAddress.state }} {{ selectedOrder.shippingAddress.postalCode }}<br>
              {{ selectedOrder.shippingAddress.country }}
            </address>
          </div>
        </div>

        <!-- Order Items -->
        <div class="row mt-4">
          <div class="col-12">
            <h5 style="color: #1e40af;">Order Items</h5>
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Product</th>
                    <th>Category</th>
                    <th>Brand</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of selectedOrder.items">
                    <td>
                      <strong>{{ item.Product.title }}</strong>
                      <br>
                      <small class="text-muted">ID: {{ item.Product.id }}</small>
                    </td>
                    <td>{{ item.Product.category | titlecase }}</td>
                    <td>{{ item.Product.brand }}</td>
                    <td>{{ formatCurrency(item.Product.price) }}</td>
                    <td>{{ item.Quantity }}</td>
                    <td><strong>{{ formatCurrency(item.TotalPrice) }}</strong></td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr class="table-info">
                    <td colspan="5"><strong>Total Amount:</strong></td>
                    <td><strong>{{ formatCurrency(selectedOrder.total) }}</strong></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- Payment Information -->
        <div class="row mt-4">
          <div class="col-12">
            <h5 style="color: #1e40af;">Payment Information</h5>
            <table class="table table-sm">
              <tr>
                <td><strong>Payment Method:</strong></td>
                <td>{{ selectedOrder.paymentMethod.type | titlecase }}</td>
              </tr>
              <tr *ngIf="selectedOrder.paymentMethod.type === 'upi'">
                <td><strong>UPI ID:</strong></td>
                <td>{{ selectedOrder.paymentMethod.upiId }}</td>
              </tr>
            </table>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div style="display: flex; justify-content: flex-end; padding: 20px; border-top: 1px solid #eee; background: #f8f9fa; border-radius: 0 0 8px 8px;">
        <button type="button" (click)="closeOrderDetails()" class="btn btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <!-- Order Processing Modal -->
  <div *ngIf="showProcessingModal && selectedOrderForProcessing" 
       style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; overflow-y: auto;">
    <div style="margin: 20px auto; max-width: 600px; background: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
      
      <!-- Modal Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #28a745; color: white; border-radius: 8px 8px 0 0;">
        <h4 style="margin: 0; color: white;">Process Order - {{ selectedOrderForProcessing.orderNumber }}</h4>
        <button type="button" (click)="closeProcessingModal()" style="background: none; border: none; color: white; font-size: 30px; cursor: pointer;">&times;</button>
      </div>

      <!-- Modal Content -->
      <div style="padding: 20px;">
        <div class="row">
          <div class="col-12">
            <div class="mb-3">
              <label class="form-label"><strong>Order Status</strong></label>
              <select class="form-select" [(ngModel)]="newStatus">
                <option [value]="selectedOrderForProcessing.orderStatus">
                  {{ selectedOrderForProcessing.orderStatus | titlecase }} (Current)
                </option>
                <option *ngFor="let status of getValidStatusTransitions()" [value]="status">
                  {{ status | titlecase }}
                </option>
              </select>
              <small class="text-muted">
                Current: {{ selectedOrderForProcessing.orderStatus | titlecase }} | 
                Next allowed: {{ getValidStatusTransitions().join(', ') || 'None' }}
              </small>
            </div>

            <div class="mb-3">
              <label class="form-label"><strong>Processing Location</strong></label>
              <select class="form-select" [(ngModel)]="selectedLocation">
                <option value="">Select Location</option>
                <option *ngFor="let location of processingLocations" [value]="location.id">
                  {{ location.name }} - {{ location.city }}, {{ location.state }}
                </option>
              </select>
              <small class="text-muted">Select where the order is being processed</small>
            </div>

            <div class="mb-3">
              <label class="form-label"><strong>Processing Notes</strong></label>
              <textarea 
                class="form-control" 
                rows="3" 
                placeholder="Add any processing notes or special instructions..."
                [(ngModel)]="processingNotes">
              </textarea>
            </div>

            <!-- Current Order Info -->
            <div class="alert alert-info">
              <h6>Order Information:</h6>
              <p><strong>Customer:</strong> {{ selectedOrderForProcessing.customerInfo.fullName }}</p>
              <p><strong>Items:</strong> {{ selectedOrderForProcessing.items.length }} items</p>
              <p><strong>Total:</strong> {{ formatCurrency(selectedOrderForProcessing.total) }}</p>
              <p><strong>Current Status:</strong> 
                <span [ngClass]="getStatusBadgeClass(selectedOrderForProcessing.orderStatus)">
                  {{ selectedOrderForProcessing.orderStatus | titlecase }}
                </span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div style="display: flex; justify-content: space-between; padding: 20px; border-top: 1px solid #eee; background: #f8f9fa; border-radius: 0 0 8px 8px;">
        <button type="button" (click)="closeProcessingModal()" class="btn btn-secondary">Cancel</button>
        <button 
          type="button" 
          (click)="processOrder()" 
          class="btn btn-success"
          [disabled]="isUpdating">
          <span *ngIf="!isUpdating">Update Order</span>
          <span *ngIf="isUpdating">
            <i class="fas fa-spinner fa-spin"></i> Updating...
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- Remove Order Modal -->
  <div *ngIf="showRemoveModal && selectedOrderForRemoval" 
       style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; overflow-y: auto;">
    <div style="margin: 20px auto; max-width: 500px; background: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
      
      <!-- Modal Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #dc3545; color: white; border-radius: 8px 8px 0 0;">
        <h4 style="margin: 0; color: white;">Remove Order - {{ selectedOrderForRemoval.orderNumber }}</h4>
        <button type="button" (click)="closeRemoveModal()" style="background: none; border: none; color: white; font-size: 30px; cursor: pointer;">&times;</button>
      </div>

      <!-- Modal Content -->
      <div style="padding: 20px;">
        <div class="alert alert-warning">
                          <h6>Warning</h6>
          <p class="mb-0">This action will permanently remove the order from the system.</p>
        </div>

        <!-- Order Info -->
        <div class="mb-3">
          <h6>Order Information:</h6>
          <p><strong>Customer:</strong> {{ selectedOrderForRemoval.customerInfo.fullName }}</p>
          <p><strong>Status:</strong> 
            <span [ngClass]="getStatusBadgeClass(selectedOrderForRemoval.orderStatus)">
              {{ selectedOrderForRemoval.orderStatus | titlecase }}
            </span>
          </p>
          <p><strong>Amount:</strong> {{ formatCurrency(selectedOrderForRemoval.total) }}</p>
        </div>

        <!-- Notification Settings -->
        <div class="mb-3" *ngIf="selectedOrderForRemoval.orderStatus !== 'delivered'">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="sendNotification" [(ngModel)]="sendNotification">
            <label class="form-check-label" for="sendNotification">
              Send notification to customer about refund
            </label>
          </div>
        </div>

        <!-- Reason for Removal -->
        <div class="mb-3" *ngIf="sendNotification && selectedOrderForRemoval.orderStatus !== 'delivered'">
          <label for="removalReason" class="form-label">Reason for Removal:</label>
          <select class="form-select" id="removalReason" [(ngModel)]="removalReason">
            <option value="">Select a reason</option>
            <option value="Unable to deliver">Unable to deliver</option>
            <option value="Product out of stock">Product out of stock</option>
            <option value="Delivery area not serviceable">Delivery area not serviceable</option>
            <option value="Payment issues">Payment issues</option>
            <option value="Customer request">Customer request</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="mb-3" *ngIf="removalReason === 'Other'">
          <label for="customReason" class="form-label">Custom Reason:</label>
          <textarea class="form-control" id="customReason" rows="3" placeholder="Please specify the reason..." [(ngModel)]="removalReason"></textarea>
        </div>

        <!-- Confirmation Message -->
        <div class="alert alert-info" *ngIf="sendNotification && selectedOrderForRemoval.orderStatus !== 'delivered'">
          <small>
            <strong>Note:</strong> Customer will receive a notification about the cancellation and refund process.
          </small>
        </div>
      </div>

      <!-- Modal Footer -->
      <div style="display: flex; justify-content: space-between; padding: 20px; border-top: 1px solid #eee; background: #f8f9fa; border-radius: 0 0 8px 8px;">
        <button type="button" (click)="closeRemoveModal()" class="btn btn-secondary">Cancel</button>
        <button 
          type="button" 
          (click)="removeOrder()" 
          class="btn btn-danger"
          [disabled]="isUpdating || (sendNotification && !removalReason)">
          <span *ngIf="!isUpdating">Remove Order</span>
          <span *ngIf="isUpdating">
            <i class="fas fa-spinner fa-spin"></i> Removing...
          </span>
        </button>
      </div>
    </div>
  </div>

</div> 