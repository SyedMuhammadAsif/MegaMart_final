<div class="admin-container">
  <!-- Admin Header -->
  <div class="admin-header theme-major-color text-light">
    <div class="container-fluid">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h2 class="mb-0">Customer Management</h2>
          <small>View and analyze customer data</small>
        </div>
        <div class="col-md-6">
          <div class="admin-nav float-end">
            <a routerLink="/admin/dashboard" class="btn btn-outline-light me-2">Dashboard</a>
            <a routerLink="/admin/products" class="btn btn-outline-light me-2" *ngIf="adminAuth.canManageProducts()">Products</a>
            <a routerLink="/admin/orders" class="btn btn-outline-light me-2" *ngIf="adminAuth.canManageOrders()">Orders</a>
            <a routerLink="/admin/customers" class="btn btn-outline-light me-2" *ngIf="adminAuth.canManageCustomers()">Customers</a>
            <a routerLink="/admin/settings" class="btn btn-outline-light me-2">Settings</a>
            <button (click)="onAdminLogout()" class="btn btn-outline-danger me-2">
              <svg width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0v2z"/>
                <path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
              </svg>
              Logout
            </button>
            <a routerLink="/" class="btn btn-light">Back to Store</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container-fluid py-4">
    
    <!-- Customer Statistics -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="text-primary">{{ customerStats.totalCustomers }}</h3>
            <p class="mb-0">Total Customers</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="text-success">{{ formatCurrency(customerStats.totalRevenue) }}</h3>
            <p class="mb-0">Total Revenue</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="text-info">{{ formatCurrency(customerStats.averageOrderValue) }}</h3>
            <p class="mb-0">Avg Order Value</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <h3 class="text-warning">{{ customerStats.newThisMonth }}</h3>
            <p class="mb-0">New This Month</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Spenders -->
    <div class="row mb-4" *ngIf="customerStats.topSpenders.length > 0">
      <div class="col-12">
        <div class="card">
          <div class="card-header theme-major-color text-light">
            <h5 class="mb-0">Top Spenders</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-12">
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Customer</th>
                        <th>Email</th>
                        <th>Orders</th>
                        <th>Total Spent</th>
                        <th>Tier</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let customer of customerStats.topSpenders">
                        <td><strong>{{ customer.name || customer.username }}</strong></td>
                        <td>{{ customer.email }}</td>
                        <td>{{ customer.totalOrders || 0 }}</td>
                        <td><strong>{{ formatCurrency(customer.totalSpent || 0) }}</strong></td>
                        <td>
                          <span [ngClass]="getCustomerTier(customer.totalSpent || 0).class">
                            {{ getCustomerTier(customer.totalSpent || 0).name }}
                          </span>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="card mb-4">
      <div class="card-header theme-major-color text-light">
        <h5 class="mb-0">Filter Customers</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-2 mb-3">
            <label class="form-label">Name</label>
            <input 
              type="text" 
              class="form-control" 
              placeholder="Search name"
              [(ngModel)]="filters.name" 
              (ngModelChange)="applyFilters()">
          </div>
          
          <div class="col-md-2 mb-3">
            <label class="form-label">Email</label>
            <input 
              type="text" 
              class="form-control" 
              placeholder="Search email"
              [(ngModel)]="filters.email" 
              (ngModelChange)="applyFilters()">
          </div>
          
          <div class="col-md-2 mb-3">
            <label class="form-label">Gender</label>
            <select class="form-select" [(ngModel)]="filters.gender" (ngModelChange)="applyFilters()">
              <option value="">All Genders</option>
              <option *ngFor="let gender of genderOptions" [value]="gender">{{ gender | titlecase }}</option>
            </select>
          </div>
          
          <div class="col-md-2 mb-3">
            <label class="form-label">City</label>
            <input 
              type="text" 
              class="form-control" 
              placeholder="Search city"
              [(ngModel)]="filters.city" 
              (ngModelChange)="applyFilters()">
          </div>
          
          <div class="col-md-2 mb-3">
            <label class="form-label">From Date</label>
            <input type="date" class="form-control" [(ngModel)]="filters.dateFrom" (ngModelChange)="applyFilters()">
          </div>
          
          <div class="col-md-1 mb-3 d-flex align-items-end">
            <button class="btn btn-outline-secondary" (click)="clearFilters()">Clear</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading customers...</span>
      </div>
      <p class="mt-2">Loading customers...</p>
    </div>

    <!-- Customers Table -->
    <div *ngIf="!isLoading" class="card">
      <div class="card-header theme-major-color text-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          Customers ({{ filteredCustomers.length }} of {{ allCustomers.length }})
        </h5>
        <div class="d-flex align-items-center">
          <label class="form-label text-light me-2 mb-0">Items per page:</label>
          <select 
            class="form-select form-select-sm items-per-page-select" 
            style="width: auto;" 
            [(ngModel)]="itemsPerPage"
            (ngModelChange)="changeItemsPerPage($event)">
            <option [value]="10">10</option>
            <option [value]="15">15</option>
            <option [value]="25">25</option>
            <option [value]="50">50</option>
          </select>
        </div>
      </div>
      
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th (click)="sortBy('name')" style="cursor: pointer;">
                  Name {{ getSortIcon('name') }}
                </th>
                <th (click)="sortBy('email')" style="cursor: pointer;">
                  Email {{ getSortIcon('email') }}
                </th>
                <th>Phone</th>
                <th (click)="sortBy('gender')" style="cursor: pointer;">
                  Gender {{ getSortIcon('gender') }}
                </th>
                <!-- <th (click)="sortBy('city')" style="cursor: pointer;">
                  City {{ getSortIcon('city') }}
                </th> -->
                <!-- <th (click)="sortBy('totalOrders')" style="cursor: pointer;">
                  Orders {{ getSortIcon('totalOrders') }}
                </th>
                <th (click)="sortBy('totalSpent')" style="cursor: pointer;">
                  Total Spent {{ getSortIcon('totalSpent') }}
                </th>
                <th>Tier</th> -->
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let customer of paginatedCustomers; trackBy: trackByCustomerId">
                <!-- Name -->
                <td>
                  <strong>{{ customer.name || customer.username }}</strong>
                  <br>
                  <small class="text-muted">ID: {{ customer.userId }}</small>
                </td>
                
                <!-- Email -->
                <td>{{ customer.email }}</td>
                
                <!-- Phone -->
                <td>{{ customer.phone || 'N/A' }}</td>
                
                <!-- Gender -->
                <td>
                  <span [ngClass]="getGenderBadgeClass(customer.gender || undefined)">
                    {{ customer.gender || 'N/A' | titlecase }}
                  </span>
                </td>
                
                <!-- City -->
                <!-- <td>N/A</td> -->
                
                <!-- Orders -->
                <!-- <td>
                  <span class="badge bg-primary" *ngIf="customer.totalOrders; else noOrders">
                    {{ customer.totalOrders }}
                  </span>
                  <ng-template #noOrders>
                    <span class="text-muted">0</span>
                  </ng-template>
                </td>
                
                <!-- Total Spent -->
                <!-- <td>
                  <strong *ngIf="customer.totalSpent; else noSpent">
                    {{ formatCurrency(customer.totalSpent) }}
                  </strong>
                  <ng-template #noSpent>
                    <span class="text-muted">$0.00</span>
                  </ng-template>
                </td>
                
                <!-- Tier -->
                <!-- <td>
                  <span [ngClass]="getCustomerTier(customer.totalSpent || 0).class">
                    {{ getCustomerTier(customer.totalSpent || 0).name }}
                  </span>
                </td> -->
                
                <!-- Actions -->
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    <button 
                      class="btn btn-outline-primary"
                      (click)="viewCustomerDetails(customer)"
                      title="View Details">
                      Details
                    </button>
                    <button 
                      class="btn btn-outline-success"
                      (click)="viewCustomerOrders(customer)"
                      *ngIf="customer.totalOrders"
                      title="View Orders">
                      Orders
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Pagination -->
      <div class="card-footer">
        <nav>
          <ul class="pagination justify-content-center mb-0">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <button class="page-link" (click)="changePage(currentPage - 1)">Previous</button>
            </li>
            
            <li *ngFor="let page of [].constructor(totalPages); let i = index" 
                class="page-item" 
                [class.active]="currentPage === i + 1">
              <button class="page-link" (click)="changePage(i + 1)">{{ i + 1 }}</button>
            </li>
            
            <li class="page-item" [class.disabled]="currentPage === totalPages">
              <button class="page-link" (click)="changePage(currentPage + 1)">Next</button>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- Customer Details Modal -->
  <div *ngIf="showCustomerDetails && selectedCustomer" 
       style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; overflow-y: auto;">
    <div style="margin: 20px auto; max-width: 800px; background: white; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
      
      <!-- Modal Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #1e40af; color: white; border-radius: 8px 8px 0 0;">
        <h4 style="margin: 0; color: white;">Customer Details - {{ selectedCustomer.name || selectedCustomer.username }}</h4>
        <button type="button" (click)="closeCustomerDetails()" style="background: none; border: none; color: white; font-size: 30px; cursor: pointer;">&times;</button>
      </div>

      <!-- Modal Content -->
      <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
        <div class="row">
          <!-- Personal Information -->
          <div class="col-md-6">
            <h5 style="color: #1e40af;">Personal Information</h5>
            <table class="table table-sm">
              <tr>
                <td><strong>Name:</strong></td>
                <td>{{ selectedCustomer.name || selectedCustomer.username }}</td>
              </tr>
              <tr>
                <td><strong>User ID:</strong></td>
                <td>{{ selectedCustomer.id }}</td>
              </tr>
              <tr>
                <td><strong>Email:</strong></td>
                <td>{{ selectedCustomer.email }}</td>
              </tr>
              <tr>
                <td><strong>Phone:</strong></td>
                <td>{{ selectedCustomer.phone || 'N/A' }}</td>
              </tr>
              <tr>
                <td><strong>Gender:</strong></td>
                <td>
                  <span [ngClass]="getGenderBadgeClass(selectedCustomer.gender || undefined)">
                    {{ selectedCustomer.gender || 'N/A' | titlecase }}
                  </span>
                </td>
              </tr>
              <tr>
                <td><strong>Date of Birth:</strong></td>
                <td>{{ selectedCustomer.dateOfBirth || 'N/A' }}</td>
              </tr>
            </table>
          </div>

          <!-- Order Statistics -->
          <!-- <div class="col-md-6">
            <h5 style="color: #1e40af;">Order Statistics</h5>
            <table class="table table-sm">
              <tr>
                <td><strong>Total Orders:</strong></td>
                <td>{{ selectedCustomer.totalOrders || 0 }}</td>
              </tr>
              <tr>
                <td><strong>Total Spent:</strong></td>
                <td><strong>{{ formatCurrency(selectedCustomer.totalSpent || 0) }}</strong></td>
              </tr>
              <tr>
                <td><strong>Customer Tier:</strong></td>
                <td>
                  <span [ngClass]="getCustomerTier(selectedCustomer.totalSpent || 0).class">
                    {{ getCustomerTier(selectedCustomer.totalSpent || 0).name }}
                  </span>
                </td>
              </tr>
              <tr>
                <td><strong>Avg Order Value:</strong></td>
                <td>{{ formatCurrency((selectedCustomer.totalSpent || 0) / (selectedCustomer.totalOrders || 1)) }}</td>
              </tr>
            </table>
          </div> -->
        </div>

        <!-- Registration Info -->
        <div class="row mt-4">
          <div class="col-12">
            <h5 style="color: #1e40af;">Registration Info</h5>
            <table class="table table-sm">
              <tr>
                <td><strong>Username:</strong></td>
                <td>{{ selectedCustomer.username }}</td>
              </tr>
              <tr>
                <td><strong>Created At:</strong></td>
                <td>{{ formatDate(selectedCustomer.createdAt) }}</td>
              </tr>
              <!-- <tr>
                <td><strong>Last Login:</strong></td>
                <td>{{ selectedCustomer.lastLogin ? formatDate(selectedCustomer.lastLogin) : 'Never' }}</td>
              </tr> -->
            </table>
          </div>
        </div>


      </div>

      <!-- Modal Footer -->
      <div style="display: flex; justify-content: flex-end; gap: 10px; padding: 20px; border-top: 1px solid #eee; background: #f8f9fa; border-radius: 0 0 8px 8px;">
        <button 
          type="button" 
          (click)="viewCustomerOrders(selectedCustomer)"
          *ngIf="selectedCustomer.totalOrders"
          class="btn btn-primary">
          View Orders
        </button>
        <button type="button" (click)="closeCustomerDetails()" class="btn btn-secondary">Close</button>
      </div>
    </div>
  </div>

</div> 