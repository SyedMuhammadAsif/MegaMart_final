<div class="container mt-4">
  <div class="row">
    <!-- Payment Form -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">
            <svg width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
              <path d="M11 5.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-1z"/>
              <path d="M2 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H2zm13 2v5H1V4a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1zm-1 9H2a1 1 0 0 1-1-1v-1h14v1a1 1 0 0 1-1 1z"/>
            </svg>
            Payment Information
          </h4>
        </div>
        <div class="card-body">
          <form [formGroup]="paymentForm" (ngSubmit)="onSubmit()" novalidate>
            
            <!-- Payment Method Selection -->
            <div class="mb-4">
              <label class="form-label fw-bold">Choose Payment Method *</label>
              <div class="row g-3">
                <!-- Credit/Debit Card -->
                <div class="col-md-4">
                  <div class="card payment-method-card" 
                       [class.selected]="selectedPaymentType === 'card'"
                       (click)="onPaymentTypeChange('card')"
                       style="cursor: pointer; border: 2px solid; transition: all 0.3s;">
                    <div class="card-body text-center py-3">
                      <svg width="24" height="24" fill="currentColor" class="mb-2" viewBox="0 0 16 16">
                        <path d="M11 5.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-1z"/>
                        <path d="M2 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H2zm13 2v5H1V4a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1zm-1 9H2a1 1 0 0 1-1-1v-1h14v1a1 1 0 0 1-1 1z"/>
                      </svg>
                      <div class="fw-bold">Card</div>
                      <small class="text-muted">Credit/Debit</small>
                    </div>
                  </div>
                </div>
                
                <!-- UPI -->
                <div class="col-md-4">
                  <div class="card payment-method-card" 
                       [class.selected]="selectedPaymentType === 'upi'"
                       (click)="onPaymentTypeChange('upi')"
                       style="cursor: pointer; border: 2px solid; transition: all 0.3s;">
                    <div class="card-body text-center py-3">
                      <svg width="24" height="24" fill="currentColor" class="mb-2" viewBox="0 0 16 16">
                        <path d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Zm.5-5v1h1a.5.5 0 0 1 0 1h-1v1a.5.5 0 0 1-1 0v-1h-1a.5.5 0 0 1 0-1h1v-1a.5.5 0 0 1 1 0Z"/>
                        <path d="M1 5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V5zM2 6h2V5H2v1z"/>
                        <path d="M6 5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V5zM7 6h2V5H7v1z"/>
                      </svg>
                      <div class="fw-bold">UPI</div>
                      <small class="text-muted">Instant Payment</small>
                    </div>
                  </div>
                </div>
                
                <!-- Cash on Delivery -->
                <div class="col-md-4">
                  <div class="card payment-method-card" 
                       [class.selected]="selectedPaymentType === 'cod'"
                       (click)="onPaymentTypeChange('cod')"
                       style="cursor: pointer; border: 2px solid; transition: all 0.3s;">
                    <div class="card-body text-center py-3">
                      <svg width="24" height="24" fill="currentColor" class="mb-2" viewBox="0 0 16 16">
                        <path d="M5.5 9.511c.076.954.83 1.697 2.182 1.785V12h.6v-.709c1.4-.098 2.218-.846 2.218-1.932 0-.987-.626-1.496-1.745-1.76l-.473-.112V5.57c.6.068.982.396 1.074.85h1.052c-.076-.919-.864-1.638-2.126-1.716V4h-.6v.719c-1.195.117-2.01.836-2.01 1.853 0 .9.606 1.472 1.613 1.707l.397.098v2.034c-.615-.093-1.022-.43-1.114-.9H5.5zm2.177-2.166c-.59-.137-.91-.416-.91-.836 0-.47.345-.822.915-.925v1.76h-.005zm.692 1.193c.717.166 1.048.435 1.048.91 0 .542-.412.914-1.135.982V8.518l.087.02z"/>
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M8 13.5a5.5 5.5 0 1 1 0-11 5.5 5.5 0 0 1 0 11zm0 .5A6 6 0 1 0 8 2a6 6 0 0 0 0 12z"/>
                      </svg>
                      <div class="fw-bold">Cash on Delivery</div>
                      <small class="text-muted">Pay at doorstep</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Payment Method Choice (for Card/UPI) -->
            <div *ngIf="selectedPaymentType !== 'cod' && userPaymentMethods.length > 0" class="mb-4">
              <label class="form-label fw-bold">Choose Payment Details</label>
              <div class="mb-3">
                <select class="form-select" 
                        [value]="selectedPaymentMethodId" 
                        (change)="onPaymentMethodChoiceChange($any($event.target).value)">
                  <option value="new">+ Add New Payment Method</option>
                  <option *ngFor="let method of userPaymentMethods" 
                          [value]="method.id"
                          [selected]="method.id === selectedPaymentMethodId">
                    {{method.type === 'card' ? 'Card ending in ' + (method.cardNumber?.slice(-4) || '****') : 'UPI: ' + method.upiId}}
                    {{method.cardholderName ? ' - ' + method.cardholderName : ''}}
                  </option>
                </select>

               
              </div>
            </div>

            <!-- Selected Existing Payment Method Display -->
            <div *ngIf="selectedPaymentType !== 'cod' && !useNewPaymentMethod && selectedPaymentMethodId && selectedPaymentMethodId !== 'new' && userPaymentMethods.length > 0" 
                 class="alert alert-info mb-4">
              <div class="d-flex align-items-center">
                <svg width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                </svg>
                <div>
                  <strong>Using Saved Payment Method:</strong><br>
                  <span *ngIf="selectedPaymentType === 'card'">
                    Card ending in {{getSelectedCardLastFour()}} - 
                    {{getSelectedPaymentMethod()?.cardholderName}}
                    <br>
                    <small class="text-muted">You'll be prompted for CVV below</small>
                  </span>
                  <span *ngIf="selectedPaymentType === 'upi'">
                    UPI: {{getSelectedPaymentMethod()?.upiId}}
                    <br>
                    <small class="text-muted">No additional details required</small>
                  </span>
                </div>
              </div>
            </div>

            <!-- CVV Input for Saved Cards -->
            <div *ngIf="showCVVInput && !useNewPaymentMethod && selectedPaymentType === 'card'" class="mb-4">
              <div class="card bg-light">
                <div class="card-body">
                  <label for="savedCardCVV" class="form-label fw-bold">
                    CVV for Card ending in {{getSelectedCardLastFour()}} *
                  </label>
                  <input 
                    type="text" 
                    class="form-control" 
                    id="savedCardCVV"
                    [value]="savedCardCVV"
                    (input)="onSavedCardCVVInput($event)"
                    maxlength="4"
                    [class.is-invalid]="hasError('savedCardCVV')"
                    placeholder="123">
                  <div class="invalid-feedback" *ngIf="hasError('savedCardCVV')">
                    {{ getErrorMessage('savedCardCVV') }}
                  </div>
                  <small class="form-text text-muted">
                    <svg width="14" height="14" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                      <path d="M8 0a1 1 0 0 1 1 1v5.268l4.562-2.634a.5.5 0 0 1 1 1.732L10 8l4.562 2.634a.5.5 0 0 1-1 1.732L9 9.732V15a1 1 0 1 1-2 0V9.732l-4.562 2.634a.5.5 0 0 1-1-1.732L6 8 1.438 5.366a.5.5 0 0 1 1-1.732L7 6.268V1a1 1 0 0 1 1-1z"/>
                    </svg>
                    Enter the 3 or 4 digit CVV from the back of your card
                  </small>
                </div>
              </div>
            </div>

            <!-- Card Payment Fields -->
            <div *ngIf="selectedPaymentType === 'card' && (useNewPaymentMethod || userPaymentMethods.length === 0)">
              <!-- Cardholder Name -->
              <div class="mb-3">
                <label for="cardholderName" class="form-label">Cardholder Name *</label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="cardholderName"
                  formControlName="cardholderName"
                  [class.is-invalid]="hasError('cardholderName')"
                  placeholder="John Doe">
                <div class="invalid-feedback" *ngIf="hasError('cardholderName')">
                  {{ getErrorMessage('cardholderName') }}
                </div>
              </div>

              <!-- Card Number -->
              <div class="mb-3">
                <label for="cardNumber" class="form-label">Card Number *</label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="cardNumber"
                  formControlName="cardNumber"
                  (input)="formatCardNumber($event)"
                  maxlength="19"
                  placeholder="1234 5678 9012 3456 (16 digits)"
                  [class.is-invalid]="hasError('cardNumber')">
                <div class="invalid-feedback" *ngIf="hasError('cardNumber')">
                  {{ getErrorMessage('cardNumber') }}
                </div>
                <small class="form-text text-muted">
                  <svg width="14" height="14" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                    <path d="M8 0a1 1 0 0 1 1 1v5.268l4.562-2.634a.5.5 0 0 1 1 1.732L10 8l4.562 2.634a.5.5 0 0 1-1 1.732L9 9.732V15a1 1 0 1 1-2 0V9.732l-4.562 2.634a.5.5 0 0 1-1-1.732L6 8 1.438 5.366a.5.5 0 0 1 1-1.732L7 6.268V1a1 1 0 0 1 1-1z"/>
                  </svg>
                  Your payment information is secure and encrypted
                </small>
              </div>

              <!-- Expiry Date and CVV -->
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="expiryMonth" class="form-label">Expiry Month *</label>
                  <select 
                    class="form-control" 
                    id="expiryMonth"
                    formControlName="expiryMonth"
                    [class.is-invalid]="hasError('expiry')">
                    <option value="" disabled>Month</option>
                    <option *ngFor="let month of months" [value]="month">{{month}}</option>
                  </select>
                  <div class="invalid-feedback" *ngIf="hasError('expiry')">
                    {{ getErrorMessage('expiry') }}
                  </div>
                </div>
                <div class="col-md-4">
                  <label for="expiryYear" class="form-label">Expiry Year *</label>
                  <select 
                    class="form-control" 
                    id="expiryYear"
                    formControlName="expiryYear"
                    [class.is-invalid]="hasError('expiry')">
                    <option value="" disabled>Year</option>
                    <option *ngFor="let year of years" [value]="year">{{year}}</option>
                  </select>
                  <div class="invalid-feedback" *ngIf="hasError('expiry')">
                    {{ getErrorMessage('expiry') }}
                  </div>
                </div>
                <div class="col-md-4">
                  <label for="cvv" class="form-label">CVV *</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    id="cvv"
                    formControlName="cvv"
                    (input)="formatCVV($event)"
                    maxlength="4"
                    placeholder="123">
                  <div class="invalid-feedback" *ngIf="hasError('cvv')">
                    {{ getErrorMessage('cvv') }}
                  </div>
                </div>
              </div>
            </div>

            <!-- UPI Payment Fields -->
            <div *ngIf="selectedPaymentType === 'upi' && (useNewPaymentMethod || userPaymentMethods.length === 0)">
              <div class="mb-3">
                <label for="upiId" class="form-label">UPI ID *</label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="upiId"
                  formControlName="upiId"
                  placeholder="yourname&#64;gpay or yourname&#64;phonepe or yourname&#64;paytm">
                <div class="invalid-feedback" *ngIf="hasError('upiId')">
                  {{ getErrorMessage('upiId') }}
                </div>
                <small class="form-text text-muted">
                  <svg width="14" height="14" fill="currentColor" class="me-1 text-info" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                  </svg>
                  Enter your UPI ID (must end with &#64;gpay, &#64;phonepe, or &#64;paytm)
                </small>
              </div>
            </div>

            <!-- Cash on Delivery Info -->
            <div *ngIf="selectedPaymentType === 'cod'">
              <div class="alert alert-info">
                <svg width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                </svg>
                <strong>Cash on Delivery</strong><br>
                Pay {{formatPrice(cart.totalPrice * 1.08)}} when your order is delivered to your doorstep. 
                Please keep exact change ready for a smooth delivery experience.
              </div>
            </div>

            <!-- Shipping Address Summary -->
            <div class="card bg-light mb-4" *ngIf="shippingAddress">
              <div class="card-header">
                <h6 class="mb-0">Shipping Address</h6>
              </div>
              <div class="card-body">
                <p class="mb-1"><strong>{{shippingAddress.fullName}}</strong></p>
                <p class="mb-1">{{shippingAddress.addressLine1}}</p>
                <p class="mb-1" *ngIf="shippingAddress.addressLine2">{{shippingAddress.addressLine2}}</p>
                <p class="mb-1">{{shippingAddress.city}}, {{shippingAddress.state}} {{shippingAddress.postalCode}}</p>
                <p class="mb-0">{{shippingAddress.country}}</p>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-outline-secondary" (click)="goBackToAddress()" [disabled]="isProcessing">
                <svg width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Back to Address
              </button>
              
              <button type="submit" class="btn btn-success" [disabled]="isProcessing" >
                <span *ngIf="isProcessing" class="spinner-border spinner-border-sm me-2" role="status">
                  <span class="visually-hidden">Loading...</span>
                </span>
                <span *ngIf="!isProcessing">
                  <svg width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                    <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/>
                  </svg>
                  {{isProcessing ? 'Processing Payment...' : 'Complete Order'}}
                </span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Order Summary -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Order Summary</h5>
        </div>
        <div class="card-body">
          <!-- Items -->
          <div *ngFor="let item of cart.items" class="d-flex justify-content-between align-items-center mb-2">
            <div class="flex-grow-1">
              <div class="fw-bold">{{item.Product?.title || 'Product'}}</div>
              <small class="text-muted">Qty: {{item.Quantity}}</small>
            </div>
            <div class="text-end">
              {{formatPrice(item.TotalPrice)}}
            </div>
          </div>
          
          <hr>
          
          <!-- Pricing Breakdown -->
          <div class="d-flex justify-content-between">
            <span>Subtotal:</span>
            <span>{{formatPrice(cart.totalPrice)}}</span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Shipping:</span>
            <span class="text-success">FREE</span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Tax (8%):</span>
            <span>{{formatPrice(cart.totalPrice * 0.08)}}</span>
          </div>
          
          <hr>
          
          <div class="d-flex justify-content-between fw-bold fs-5">
            <span>Total:</span>
            <span>{{formatPrice(cart.totalPrice * 1.08)}}</span>
          </div>

          <!-- Security Notice -->
          <div class="mt-3 p-2 bg-light rounded">
            <small class="text-muted d-flex align-items-center">
              <svg width="14" height="14" fill="currentColor" class="me-1 text-success" viewBox="0 0 16 16">
                <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
              </svg>
              Secure 256-bit SSL encryption
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div> 

<!-- Simple payment/COD overlay -->
<div *ngIf="isOverlayVisible" class="checkout-overlay d-flex align-items-center justify-content-center">
  <div class="overlay-card text-center p-4">
    <div *ngIf="overlayStage === 'loading'" class="mb-3">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    </div>
    <div *ngIf="overlayStage === 'success'" class="mb-3">
      <div class="success-tick">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke="#10b981" stroke-width="2" fill="rgba(16,185,129,0.1)"/>
          <path d="M7 12l3 3 7-7" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>
    <h5 class="mb-1">{{ overlayTitle }}</h5>
    <small class="text-muted">{{ overlaySubtitle }}</small>
  </div>
</div> 