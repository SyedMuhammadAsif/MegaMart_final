
<app-payment-toast></app-payment-toast>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <!-- Loading State -->
      <div *ngIf="isLoading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading order details...</p>
      </div>

      <!-- Success Message -->
      <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
        {{successMessage}}
        <button type="button" class="btn-close" (click)="successMessage = ''"></button>
      </div>
      
      <!-- Error State -->
      <div *ngIf="error && !isLoading" class="alert alert-danger text-center" role="alert">
        <svg width="24" height="24" fill="currentColor" class="me-2" viewBox="0 0 16 16">
          <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
        </svg>
        {{error}}
        <div class="mt-3">
          <button class="btn btn-outline-primary" (click)="continueShopping()">
            Continue Shopping
          </button>
        </div>
      </div>

      <!-- Order Details -->
      <div *ngIf="order && !isLoading && !error">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2 class="mb-1">Order Tracking</h2>
            <p class="text-muted mb-0">Order #{{order.orderNumber}}</p>
          </div>
          <div class="d-flex gap-2">
            <button *ngIf="canCancelOrder()" class="btn btn-danger" (click)="openCancelModal()">
              <svg width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
              </svg>
              Cancel Order
            </button>
            <button class="btn btn-outline-primary" (click)="continueShopping()">
              <svg width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
              </svg>
              Continue Shopping
            </button>
          </div>
        </div>

        <div class="row">
          <!-- Order Summary -->
          <div class="col-lg-4 mb-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Order Summary</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <strong>Order Date:</strong><br>
                  <span class="text-muted">{{formatDate(order.orderDate)}}</span>
                </div>
                <div class="mb-3">
                  <strong>Status:</strong><br>
                  <span class="badge bg-{{getStatusColor(order.orderStatus || '')}}">
                    {{(order.orderStatus || '').charAt(0).toUpperCase() + (order.orderStatus || '').slice(1)}}
                  </span>
                </div>
                <div class="mb-3">
                  <strong>Payment Status:</strong><br>
                  <span class="badge" [ngClass]="'bg-' + getPaymentStatusColor(order.paymentStatus || '')">
                    {{(order.paymentStatus || '').charAt(0).toUpperCase() + (order.paymentStatus || '').slice(1)}}
                  </span>
                </div>
                <div class="mb-3">
                  <strong>Payment Method:</strong><br>
                  <span class="text-muted">
                    <ng-container [ngSwitch]="order.paymentMethod.type">
                      <span *ngSwitchCase="'cod'">Cash on Delivery</span>
                      <span *ngSwitchCase="'card'">Credit/Debit Card</span>
                      <span *ngSwitchCase="'upi'">UPI Payment</span>
                      <span *ngSwitchDefault>Unknown</span>
                    </ng-container>
                  </span>
                </div>
                <div class="mb-3">
                  <strong>Estimated Delivery:</strong><br>
                  <span class="text-muted">{{order.estimatedDelivery}}</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-2">
                  <span>Subtotal:</span>
                  <span>{{formatPrice(order.subtotal)}}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span>Tax:</span>
                  <span>{{formatPrice(order.tax)}}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span>Shipping:</span>
                  <span>{{formatPrice(order.shipping)}}</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between fw-bold">
                  <span>Total:</span>
                  <span>{{formatPrice(order.total)}}</span>
                </div>
                <hr>
                <div class="d-grid gap-2" *ngIf="canCancelOrder()">
                  
                </div>
                <div class="text-center mt-2" *ngIf="!canCancelOrder() && order.orderStatus !== 'cancelled'">
                  <small class="text-muted">Order cannot be cancelled at this stage</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Tracking Progress -->
          <div class="col-lg-8 mb-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Order Progress</h5>
              </div>
              <div class="card-body">
                <div class="tracking-timeline">
                  <div *ngFor="let step of trackingSteps; let i = index" class="tracking-step mb-0" [class.completed]="step.completed" [class.current]="step.current">
                    <div class="step-indicator">
                      <div class="step-number">
                        <span *ngIf="step.completed">✓</span>
                        <span *ngIf="!step.completed">{{i + 1}}</span>
                      </div>
                    </div>
                    <div class="step-content">
                      <h6 class="step-title">{{step.title}}</h6>
                      <p class="step-description text-muted">{{step.description}}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Order Items -->
            <div class="card mt-4">
              <div class="card-header">
                <h5 class="mb-0">Order Items</h5>
              </div>
              <div class="card-body">
                <div *ngFor="let item of order.items" class="order-item d-flex align-items-center mb-3">
                  <div class="item-image me-3">
                    <div class="bg-light d-flex align-items-center justify-content-center" 
                         style="width: 60px; height: 60px; border-radius: 4px;">
                      <svg width="24" height="24" fill="currentColor" class="text-muted" viewBox="0 0 16 16">
                        <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                        <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                      </svg>
                    </div>
                  </div>
                  <div class="item-details flex-grow-1">
                    <h6 class="mb-1">{{item.productName || item.Product?.title || 'Product'}}</h6>
                    <p class="text-muted small mb-1">Quantity: {{item.quantity || item.Quantity || 0}}</p>
                    <p class="text-muted small mb-0">Price: {{formatPrice(item.price || item.TotalPrice || 0)}}</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Enhanced Tracking Information -->
            <div class="card mt-4" *ngIf="order.currentLocation || order.processingNotes">
              <div class="card-header">
                <h5 class="mb-0">Processing Information</h5>
              </div>
              <div class="card-body">
                <div *ngIf="order.currentLocation" class="mb-3">
                  <h6>Current Location:</h6>
                  <p class="mb-1"><strong>{{order.currentLocation.name}}</strong></p>
                  <p class="mb-1">{{order.currentLocation.address}}</p>
                  <p class="mb-1">{{order.currentLocation.city}}, {{order.currentLocation.state}} {{order.currentLocation.postalCode}}</p>
                  <p class="mb-0">{{order.currentLocation.country}}</p>
                </div>
                
                <div *ngIf="order.processingNotes" class="mb-3">
                  <h6>Processing Notes:</h6>
                  <p class="text-muted">{{order.processingNotes}}</p>
                </div>
                
                <div *ngIf="order.lastUpdated" class="mb-3">
                  <h6>Last Updated:</h6>
                  <p class="text-muted">{{formatDate(order.lastUpdated)}} by {{order.updatedBy || 'System'}}</p>
                </div>
              </div>
            </div>

            <!-- Detailed Tracking History -->
            <div class="card mt-4" *ngIf="trackingHistory.length > 0">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Detailed Tracking History</h5>
                <button 
                  class="btn btn-outline-primary btn-sm" 
                  (click)="toggleTrackingHistory()">
                  {{ showTrackingHistory ? 'Hide' : 'Show' }} Details
                </button>
              </div>
              <div class="card-body" *ngIf="showTrackingHistory">
                <div class="timeline">
                  <div *ngFor="let entry of trackingHistory; let i = index" class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <h6 class="mb-1">{{entry.status | titlecase}}</h6>
                          <p class="text-muted mb-1">{{entry.description}}</p>
                          <p *ngIf="entry.location" class="text-muted small mb-1">
                            <i class="fas fa-map-marker-alt"></i> {{entry.location}}
                          </p>
                          <p *ngIf="entry['processingNotes']" class="text-info small mb-0">
                            <strong>Notes:</strong> {{entry['processingNotes']}}
                          </p>
                        </div>
                        <div class="text-end">
                          <small class="text-muted">{{formatDate(entry.timestamp)}}</small>
                          <p *ngIf="entry.updatedBy" class="text-muted small mb-0">by {{entry.updatedBy}}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Shipping Address -->
            <div class="card mt-4">
              <div class="card-header">
                <h5 class="mb-0">Shipping Address</h5>
              </div>
              <div class="card-body">
                <p class="mb-1"><strong>{{order.shippingAddress?.fullName}}</strong></p>
                <p class="mb-1">{{order.shippingAddress?.addressLine1}}</p>
                <p *ngIf="order.shippingAddress?.addressLine2" class="mb-1">{{order.shippingAddress?.addressLine2}}</p>
                <p class="mb-1">{{order.shippingAddress?.city}}, {{order.shippingAddress?.state}} {{order.shippingAddress?.postalCode}}</p>
                <p class="mb-0">{{order.shippingAddress?.country}}</p>
                <p class="mb-0 mt-2">
                  <strong>Phone:</strong> {{order.shippingAddress?.phone}}<br>
                  <strong>Email:</strong> {{order.shippingAddress?.email}}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Cancel Order Modal -->
  <div *ngIf="showCancelModal" class="modal-overlay" (click)="closeCancelModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h5>Cancel Order</h5>
        <button (click)="closeCancelModal()" class="btn-close">×</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to cancel this order?</p>
        <p class="text-muted">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeCancelModal()">Keep Order</button>
        <button class="btn btn-danger" (click)="cancelOrder()">Cancel Order</button>
      </div>
    </div>
  </div>
</div> 