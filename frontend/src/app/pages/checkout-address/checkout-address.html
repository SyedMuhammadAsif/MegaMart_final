<div class="container mt-4">
  <div class="row">
    <!-- Address Form -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">
            <svg width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
              <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5  15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5ZM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5 5 5Z"/>
            </svg>
            Shipping Address
          </h4>
        </div>
        <div class="card-body">
          <!-- Saved addresses selection -->
          <div *ngIf="userAddresses.length > 0" class="mb-4">
            <h6 class="fw-bold">Select a saved address</h6>
            <div class="list-group">
              <label class="list-group-item" *ngFor="let a of userAddresses">
                <input class="form-check-input me-2" type="radio" name="savedAddress" [value]="a.id" [checked]="selectedAddressId===a.id" (change)="onAddressChoiceChange(a.id!)">
                <div>
                  <div class="fw-semibold">{{ a.fullName }} â€¢ {{ a.phone }}</div>
                  <div class="small text-muted">
                    {{ a.addressLine1 }}
                    <span *ngIf="a.addressLine2">, {{ a.addressLine2 }}</span>,
                    {{ a.city }}, {{ a.state }} {{ a.postalCode }}
                  </div>
                </div>
              </label>
            </div>
            <div class="form-check mt-3">
              <input class="form-check-input" type="radio" id="useNew" name="savedAddress" value="new" [checked]="selectedAddressId==='new'" (change)="onAddressChoiceChange('new')">
              <label class="form-check-label" for="useNew">Use a new address</label>
            </div>
            <div class="d-flex mt-3">
              <button class="btn btn-primary" type="button" [disabled]="!selectedAddressId || selectedAddressId==='new'" (click)="useSelectedAddress()">Use selected address</button>
            </div>
            <hr>
          </div>

          <form *ngIf="useNewAddress || userAddresses.length===0" #addressForm="ngForm" (ngSubmit)="onSubmit(addressForm)" novalidate>
            <!-- Personal Information -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="fullName" class="form-label">Full Name *</label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="fullName"
                  name="fullName"
                  [(ngModel)]="address.fullName"
                  required
                  minlength="2"
                  #fullName="ngModel"
                  [class.is-invalid]="hasError('fullName') || (fullName.invalid && fullName.touched)"
                  placeholder="Enter your full name (min 2 characters)">
                <div class="invalid-feedback" *ngIf="hasError('fullName') || (fullName.invalid && fullName.touched)">
                  <span *ngIf="hasError('fullName')">{{ getErrorMessage('fullName') }}</span>
                  <span *ngIf="!hasError('fullName') && fullName.errors?.['required']">Full name is required</span>
                  <span *ngIf="!hasError('fullName') && fullName.errors?.['minlength']">Full name must be at least 2 characters</span>
                </div>
              </div>
              <div class="col-md-6">
                <label for="email" class="form-label">Email *</label>
                <input 
                  type="email" 
                  class="form-control" 
                  id="email"
                  name="email"
                  [(ngModel)]="address.email"
                  required
                  email
                  #email="ngModel"
                  [class.is-invalid]="hasError('email') || (email.invalid && email.touched)">
                <div class="invalid-feedback" *ngIf="hasError('email') || (email.invalid && email.touched)">
                  <span *ngIf="hasError('email')">{{ getErrorMessage('email') }}</span>
                  <span *ngIf="!hasError('email') && email.errors?.['required']">Email is required</span>
                  <span *ngIf="!hasError('email') && email.errors?.['email']">Please enter a valid email</span>
                </div>
              </div>
            </div>

            <!-- Phone -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="phone" class="form-label">Phone Number *</label>
                <input 
                  type="tel" 
                  class="form-control" 
                  id="phone"
                  name="phone"
                  [(ngModel)]="address.phone"
                  required
                  pattern="[0-9]{10}"
                  maxlength="10"
                  #phone="ngModel"
                  [class.is-invalid]="hasError('phone') || (phone.invalid && phone.touched)"
                  placeholder="1234567890 (10 digits only)"
                  (input)="formatPhoneNumber($event)">
                <div class="invalid-feedback" *ngIf="hasError('phone') || (phone.invalid && phone.touched)">
                  <span *ngIf="hasError('phone')">{{ getErrorMessage('phone') }}</span>
                  <span *ngIf="!hasError('phone') && phone.errors?.['required']">Phone number is required</span>
                  <span *ngIf="!hasError('phone') && phone.errors?.['pattern']">Phone number must be exactly 10 digits</span>
                </div>
              </div>
            </div>

            <!-- Address Lines -->
            <div class="mb-3">
              <label for="addressLine1" class="form-label">Address Line 1 *</label>
              <input 
                type="text" 
                class="form-control" 
                id="addressLine1"
                name="addressLine1"
                [(ngModel)]="address.addressLine1"
                required
                minlength="5"
                #addressLine1="ngModel"
                [class.is-invalid]="hasError('addressLine1') || (addressLine1.invalid && addressLine1.touched)"
                placeholder="Street address, P.O. box">
              <div class="invalid-feedback" *ngIf="hasError('addressLine1') || (addressLine1.invalid && addressLine1.touched)">
                <span *ngIf="hasError('addressLine1')">{{ getErrorMessage('addressLine1') }}</span>
                <span *ngIf="!hasError('addressLine1') && addressLine1.errors?.['required']">Address is required</span>
                <span *ngIf="!hasError('addressLine1') && addressLine1.errors?.['minlength']">Address must be at least 5 characters</span>
              </div>
            </div>

            <div class="mb-3">
              <label for="addressLine2" class="form-label">Address Line 2</label>
              <input 
                type="text" 
                class="form-control" 
                id="addressLine2"
                name="addressLine2"
                [(ngModel)]="address.addressLine2"
                placeholder="Apartment, suite, unit, building, floor, etc.">
            </div>

            <!-- Country Selection (First) -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="country" class="form-label">Country *</label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="country"
                  name="country"
                  [(ngModel)]="address.country"
                  readonly
                  value="India">
                <small class="form-text text-muted">Currently supporting India only</small>
              </div>
            </div>

            <!-- State Selection (Second) -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="state" class="form-label">State *</label>
                <select 
                  class="form-control" 
                  id="state"
                  name="state"
                  [(ngModel)]="address.state"
                  required
                  (change)="onStateChange()"
                  [class.is-invalid]="hasError('state')"
                  #state="ngModel">
                  <option value="" disabled>Select State</option>
                  <option *ngFor="let stateData of indiaStates" [value]="stateData.code">{{ stateData.name }}</option>
                </select>
                <div class="invalid-feedback" *ngIf="hasError('state')">
                  {{ getErrorMessage('state') }}
                </div>
              </div>
            </div>

            <!-- City Selection (Third) -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="city" class="form-label">City *</label>
                <select 
                  class="form-control" 
                  id="city"
                  name="city"
                  [(ngModel)]="address.city"
                  required
                  (change)="onCityChange()"
                  [class.is-invalid]="hasError('city')"
                  #city="ngModel"
                  [disabled]="!address.state">
                  <option value="" disabled>{{ address.state ? 'Select City' : 'Select State first' }}</option>
                  <option *ngFor="let cityName of availableCities" [value]="cityName">{{ cityName }}</option>
                </select>
                <div class="invalid-feedback" *ngIf="hasError('city')">
                  {{ getErrorMessage('city') }}
                </div>
              </div>
            </div>

            <!-- PIN Code (Fourth) -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="postalCode" class="form-label">PIN Code *</label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="postalCode"
                  name="postalCode"
                  [(ngModel)]="address.postalCode"
                  required
                  pattern="[0-9]{6}"
                  maxlength="6"
                  #postalCode="ngModel"
                  [class.is-invalid]="hasError('postalCode') || (postalCode.invalid && postalCode.touched)"
                  placeholder="123456 (6 digits only)"
                  (input)="formatPinCode($event)"
                  [disabled]="!address.city">
                <div class="invalid-feedback" *ngIf="hasError('postalCode') || (postalCode.invalid && postalCode.touched)">
                  <span *ngIf="hasError('postalCode')">{{ getErrorMessage('postalCode') }}</span>
                  <span *ngIf="!hasError('postalCode') && postalCode.errors?.['required']">PIN code is required</span>
                  <span *ngIf="!hasError('postalCode') && postalCode.errors?.['pattern']">PIN code must be exactly 6 digits</span>
                </div>
                <small class="form-text text-muted" *ngIf="!address.city">Select city first to enter PIN code</small>
              </div>
            </div>

            <!-- Default Address Checkbox -->
            <div class="form-check mb-4">
              <input 
                class="form-check-input" 
                type="checkbox" 
                id="isDefault"
                name="isDefault"
                [(ngModel)]="address.isDefault">
              <label class="form-check-label" for="isDefault">
                Save as default shipping address
              </label>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-outline-secondary" (click)="goBackToCart()">
                <svg width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Back to Cart
              </button>
              <button type="submit" class="btn btn-primary" [disabled]="addressForm.invalid">
                Continue to Payment
                <svg width="16" height="16" fill="currentColor" class="ms-1" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
                </svg>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Order Summary -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Order Summary</h5>
        </div>
        <div class="card-body">
          <div *ngFor="let item of cart.items" class="d-flex justify-content-between align-items-center mb-2">
            <div class="flex-grow-1">
              <div class="fw-bold">{{item.Product?.title || 'Product'}}</div>
              <small class="text-muted">Qty: {{item.Quantity}}</small>
            </div>
            <div class="text-end">
              {{formatPrice(item.TotalPrice)}}
            </div>
          </div>
          
          <hr>
          
          <div class="d-flex justify-content-between">
            <span>Subtotal:</span>
            <span>{{formatPrice(cart.totalPrice)}}</span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Shipping:</span>
            <span class="text-success">FREE</span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Tax:</span>
            <span>{{formatPrice(cart.totalPrice * 0.08)}}</span>
          </div>
          
          <hr>
          
          <div class="d-flex justify-content-between fw-bold fs-5">
            <span>Total:</span>
            <span>{{formatPrice(cart.totalPrice * 1.08)}}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div> 